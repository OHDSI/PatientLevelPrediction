<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Integration of GIS Data Into OHDSI Model Building • PatientLevelPrediction</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Integration of GIS Data Into OHDSI Model Building">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PatientLevelPrediction</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">6.5.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/InstallationGuide.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/AddingCustomFeatureEngineering.html">Adding Custom Feature Engineering Functions</a></li>
    <li><a class="dropdown-item" href="../articles/AddingCustomModels.html">Adding Custom Patient-Level Prediction Algorithms</a></li>
    <li><a class="dropdown-item" href="../articles/AddingCustomSamples.html">Adding Custom Sampling Functions</a></li>
    <li><a class="dropdown-item" href="../articles/AddingCustomSplitting.html">Adding Custom Data Splitting</a></li>
    <li><a class="dropdown-item" href="../articles/BenchmarkTasks.html">Benchmark Tasks</a></li>
    <li><a class="dropdown-item" href="../articles/BestPractices.html">Best Practice Research</a></li>
    <li><a class="dropdown-item" href="../articles/BuildingMultiplePredictiveModels.html">Automatically Build Multiple Patient-Level Predictive Models</a></li>
    <li><a class="dropdown-item" href="../articles/BuildingPredictiveModels.html">Building patient-level predictive models</a></li>
    <li><a class="dropdown-item" href="../articles/ClinicalModels.html">Clinical Models</a></li>
    <li><a class="dropdown-item" href="../articles/ConstrainedPredictors.html">Constrained Predictors</a></li>
    <li><a class="dropdown-item" href="../articles/CreatingLearningCurves.html">Creating Learning Curves</a></li>
    <li><a class="dropdown-item" href="../articles/CreatingNetworkStudies.html">Making patient-level predictive network study packages</a></li>
    <li><a class="dropdown-item" href="../articles/GISExample.html">Integration of GIS Data Into OHDSI Model Building</a></li>
    <li><a class="dropdown-item" href="../articles/InstallationGuide.html">Patient-Level Prediction Installation Guide</a></li>
    <li><a class="dropdown-item" href="../articles/Videos.html">Demo Videos</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/BenchmarkTasks.html">Benchmarks</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/ConstrainedPredictors.html">Predictors</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/BestPractices.html">Best Practices</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/ClinicalModels.html">Clinical Models</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/PatientLevelPrediction"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Integration of GIS Data Into OHDSI Model Building</h1>
                        <h4 data-toc-skip class="author">Jared
Houghtaling</h4>
            
            <h4 data-toc-skip class="date">2025-10-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/PatientLevelPrediction/blob/develop/vignettes/GISExample.Rmd" class="external-link"><code>vignettes/GISExample.Rmd</code></a></small>
      <div class="d-none name"><code>GISExample.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="integration-of-gis-data-into-ohdsi-model-building">Integration of GIS Data into OHDSI Model Building<a class="anchor" aria-label="anchor" href="#integration-of-gis-data-into-ohdsi-model-building"></a>
</h2>
<div class="section level3">
<h3 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h3>
<p>Although the proposed GIS extension tables have been approved by the
broader OHDSI community, they are not yet integrated natively into the
OHDSI tooling. These tables and the data they capture, however, can
still be referenced in standard model building and analytics workflows.
The purpose of this analytics demonstration is to show how data in the
EXPOSURE_OCCURRENCE table can be utilized in the training and evaluation
of an OMOP-specific patient-level-prediction (PLP) model. The analytic
process we executed and describe below relies on a GIS-version of the
Tufts Synthetic Dataset that has both EHR and geospatial data
integrated; see the <a href="https://github.com/OHDSI/GIS/issues/345#issuecomment-2417261931" class="external-link">description</a>
of that dataset for more details about contents or access. Much of the
work is based on the detailed vignette that describes custom feature
engineering in PLP
<code><a href="../articles/AddingCustomFeatureEngineering.html">vignette('AddingCustomFeatureEngineering')</a></code></p>
</div>
<div class="section level3">
<h3 id="step-by-step-process">Step-by-Step Process<a class="anchor" aria-label="anchor" href="#step-by-step-process"></a>
</h3>
<div class="section level4">
<h4 id="step-1-create-target-outcome-cohorts">Step 1: Create Target &amp; Outcome Cohorts<a class="anchor" aria-label="anchor" href="#step-1-create-target-outcome-cohorts"></a>
</h4>
<p>We defined our <code>target</code> cohort within the sampling
procedures when creating a subset of the Tufts Synthetic Data, and we
described this process at length elsewhere. For the purposes of using
the PLP package, we formalized this group of individuals in the cohort
table using a simple cohort definition including all individuals with
“any visit”, and include that atlas-compatible json definition here for
reference.</p>
<p>We also created our <code>outcome</code> cohort - in this case, those
patients with COPD or a conceptual descendant thereof - in Atlas and
have shared the json definition (we also included an equivalent SQL
script).</p>
</div>
<div class="section level4">
<h4 id="step-2-create-generic-plp-lasso-logistic-regression-model-in-r">Step 2: Create Generic PLP Lasso Logistic Regression Model in R<a class="anchor" aria-label="anchor" href="#step-2-create-generic-plp-lasso-logistic-regression-model-in-r"></a>
</h4>
<p>It is possible to create an R package that serves as a basis for a
PLP model using Atlas, but given Atlas does not yet support the GIS
extension, we have created this demo model directly using the PLP
package.</p>
<p>After configuring the environment (very important!) appropriately, we
imported necessary packages and defined the relevant parameters about
the data source:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/PatientLevelPrediction/">PatientLevelPrediction</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">outputFolder</span> <span class="op">&lt;-</span> <span class="st">"/ohdsi-gis/copdResultsPM25_NEW"</span></span>
<span><span class="va">saveDirectory</span> <span class="op">&lt;-</span> <span class="va">outputFolder</span></span>
<span><span class="va">ExecutionDateTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">logSettings</span> <span class="op">=</span> <span class="fu"><a href="../reference/createLogSettings.html">createLogSettings</a></span><span class="op">(</span>verbosity <span class="op">=</span> <span class="st">"DEBUG"</span>, timeStamp <span class="op">=</span> <span class="cn">T</span>, logName <span class="op">=</span></span>
<span>                                  <span class="st">"runPlp Log"</span><span class="op">)</span></span>
<span><span class="va">analysisName</span> <span class="op">=</span> <span class="st">'Generic PLP'</span></span>
<span></span>
<span><span class="co"># Details for connecting to the server:</span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span></span>
<span>        dbms <span class="op">=</span> <span class="st">'spark'</span>,</span>
<span>        server <span class="op">=</span> <span class="st">'/default'</span>,</span>
<span>        connectionString <span class="op">=</span> <span class="st">'&lt;REDACTED&gt;'</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co"># Add the database containing the OMOP CDM data</span></span>
<span><span class="va">cdmDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">'gis_syn_dataset_5_4'</span></span>
<span><span class="co"># Add a sharebale name for the database containing the OMOP CDM data</span></span>
<span><span class="va">cdmDatabaseName</span> <span class="op">&lt;-</span> <span class="st">'TSD-GIS'</span></span>
<span><span class="co"># Add a database with read/write access as this is where the cohorts will be generated</span></span>
<span><span class="va">cohortDatabaseSchema</span> <span class="op">&lt;-</span> <span class="st">'gis_syn_dataset_5_4'</span></span>
<span><span class="va">tempEmulationSchema</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="co"># table name where the cohorts will be generated</span></span>
<span><span class="va">cohortTable</span> <span class="op">&lt;-</span> <span class="st">'cohort'</span></span></code></pre></div>
<p>After defining parameters, we created a database settings object and
launched the <code>runMultiplePLP</code> function to create a base
<code>plpData</code> object:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">databaseDetails</span> <span class="op">&lt;-</span> <span class="fu">PatientLevelPrediction</span><span class="fu">::</span><span class="fu"><a href="../reference/createDatabaseDetails.html">createDatabaseDetails</a></span><span class="op">(</span></span>
<span>        connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>, </span>
<span>        cdmDatabaseSchema <span class="op">=</span> <span class="va">cdmDatabaseSchema</span>, </span>
<span>        cdmDatabaseName <span class="op">=</span> <span class="va">cdmDatabaseName</span>, </span>
<span>        tempEmulationSchema <span class="op">=</span> <span class="va">tempEmulationSchema</span>, </span>
<span>        cohortDatabaseSchema <span class="op">=</span> <span class="va">cohortDatabaseSchema</span>, </span>
<span>        cohortTable <span class="op">=</span> <span class="va">cohortTable</span>, </span>
<span>        outcomeDatabaseSchema <span class="op">=</span> <span class="va">cohortDatabaseSchema</span>,  </span>
<span>        outcomeTable <span class="op">=</span> <span class="va">cohortTable</span>, </span>
<span>        cdmVersion <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Run very simple LR model against two cohorts created in Atlas. Use model </span></span>
<span><span class="co"># as basis for augmented model with pollutants below </span></span>
<span><span class="fu"><a href="../reference/runMultiplePlp.html">runMultiplePlp</a></span><span class="op">(</span></span>
<span>   databaseDetails <span class="op">=</span> <span class="va">databaseDetails</span>,</span>
<span>   modelDesignList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>targetId <span class="op">=</span> <span class="fl">9</span>, outcomeId <span class="op">=</span> <span class="fl">8</span>, modelSettings <span class="op">=</span></span>
<span>                                              <span class="fu"><a href="../reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>   onlyFetchData <span class="op">=</span> <span class="cn">F</span>,</span>
<span>   cohortDefinitions <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>   logSettings <span class="op">=</span> <span class="fu"><a href="../reference/createLogSettings.html">createLogSettings</a></span><span class="op">(</span>verbosity <span class="op">=</span> <span class="st">"DEBUG"</span>, timeStamp <span class="op">=</span> <span class="cn">T</span>, logName <span class="op">=</span></span>
<span>                                     <span class="st">"runPlp Log"</span><span class="op">)</span>,</span>
<span>   saveDirectory <span class="op">=</span> <span class="va">outputFolder</span>,</span>
<span>   sqliteLocation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">saveDirectory</span>, <span class="st">"sqlite"</span><span class="op">)</span></span>
<span> <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-3-split-plpdata-object-to-traintest-augment-labels-with-exposure_occurrence-values">Step 3: Split plpData object to train/test, augment labels with
EXPOSURE_OCCURRENCE values<a class="anchor" aria-label="anchor" href="#step-3-split-plpdata-object-to-traintest-augment-labels-with-exposure_occurrence-values"></a>
</h4>
<p>The labels sub-object within <code>plpData</code> contains
per-individual data elements like gender and age; we added an additional
data element to this object derived from the
<code>EXPOSURE_OCCURRENCE</code> table:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortDefinitions</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">modelDesign</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span>targetId <span class="op">=</span> <span class="fl">9</span>, outcomeId <span class="op">=</span> <span class="fl">8</span>, modelSettings <span class="op">=</span> <span class="fu"><a href="../reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">populationSettings</span> <span class="op">&lt;-</span> <span class="va">modelDesign</span><span class="op">$</span><span class="va">populationSettings</span></span>
<span><span class="va">splitSettings</span> <span class="op">&lt;-</span> <span class="va">modelDesign</span><span class="op">$</span><span class="va">splitSettings</span></span>
<span></span>
<span><span class="va">plpData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loadPlpData.html">loadPlpData</a></span><span class="op">(</span><span class="st">"/ohdsi-gis/copdResultsPM25_B/targetId_9_L1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mySplit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splitData.html">splitData</a></span> <span class="op">(</span>plpData <span class="op">=</span> <span class="va">plpData</span>,</span>
<span>                      population <span class="op">=</span> <span class="fu"><a href="../reference/createStudyPopulation.html">createStudyPopulation</a></span><span class="op">(</span><span class="va">plpData</span>, <span class="fl">8</span>, <span class="va">populationSettings</span><span class="op">)</span>,</span>
<span>                      splitSettings <span class="op">=</span> <span class="va">splitSettings</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">labelTrain</span> <span class="op">&lt;-</span> <span class="va">mySplit</span><span class="op">$</span><span class="va">Train</span><span class="op">$</span><span class="va">labels</span></span>
<span><span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span>
<span><span class="va">pollutants</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/querySql.html" class="external-link">querySql</a></span><span class="op">(</span><span class="va">conn</span>, <span class="st">"SELECT person_id as subjectID, CAST(MEAN(value_as_number) AS DOUBLE) AS pmValue FROM gis_syn_dataset_5_4.exposure_occurrence WHERE value_as_number IS NOT NULL GROUP BY person_id;"</span><span class="op">)</span></span>
<span><span class="va">labelTrainPol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">labelTrain</span>, y<span class="op">=</span><span class="va">pollutants</span>, by.x <span class="op">=</span> <span class="st">"subjectId"</span>, by.y <span class="op">=</span> <span class="st">"SUBJECTID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mySplit</span><span class="op">$</span><span class="va">Train</span><span class="op">$</span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="va">labelTrainPol</span></span>
<span></span>
<span><span class="va">labelTest</span> <span class="op">&lt;-</span> <span class="va">mySplit</span><span class="op">$</span><span class="va">Test</span><span class="op">$</span><span class="va">labels</span></span>
<span><span class="va">labelTestPol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">labelTest</span>, y<span class="op">=</span><span class="va">pollutants</span>, by.x <span class="op">=</span> <span class="st">"subjectId"</span>, by.y <span class="op">=</span> <span class="st">"SUBJECTID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mySplit</span><span class="op">$</span><span class="va">Test</span><span class="op">$</span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="va">labelTestPol</span></span>
<span></span>
<span><span class="va">trainData</span> <span class="op">&lt;-</span> <span class="va">mySplit</span><span class="op">$</span><span class="va">Train</span></span>
<span></span>
<span><span class="va">testData</span> <span class="op">&lt;-</span> <span class="va">mySplit</span><span class="op">$</span><span class="va">Test</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-4-reference-augmented-label-objects-in-custom-feature-engineering-function">Step 4: Reference augmented label objects in custom feature
engineering function<a class="anchor" aria-label="anchor" href="#step-4-reference-augmented-label-objects-in-custom-feature-engineering-function"></a>
</h4>
<p>We would like to convert our per-patient labels into the
<code>covariateData</code> structure referenced by the PLP workflow. To
do this, we were able to follow the feature engineering vignette and
create two functions, <code>createPollutants</code> and
<code>implementPollutants</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">createPollutants</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>                     <span class="va">method</span> <span class="op">=</span> <span class="st">'QNCV'</span></span>
<span>                     <span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># create list of inputs to implement function</span></span>
<span>  <span class="va">featureEngineeringSettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="va">method</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># specify the function that will implement the sampling</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">featureEngineeringSettings</span>, <span class="st">"fun"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"implementPollutants"</span></span>
<span></span>
<span>  <span class="co"># make sure the object returned is of class "sampleSettings"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">featureEngineeringSettings</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"featureEngineeringSettings"</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">featureEngineeringSettings</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">implementPollutants</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trainData</span>, <span class="va">featureEngineeringSettings</span>, <span class="va">model</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">method</span> <span class="op">&lt;-</span> <span class="va">featureEngineeringSettings</span><span class="op">$</span><span class="va">method</span></span>
<span>    <span class="va">gisData</span> <span class="op">&lt;-</span> <span class="va">trainData</span><span class="op">$</span><span class="va">labels</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">gisData</span><span class="op">$</span><span class="va">outcomeCount</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">gisData</span><span class="op">$</span><span class="va">PMVALUE</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>      <span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">X</span>, bs<span class="op">=</span><span class="st">'cr'</span>, k<span class="op">=</span><span class="fl">5</span>, m<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">newData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      rowId <span class="op">=</span> <span class="va">gisData</span><span class="op">$</span><span class="va">rowId</span>,</span>
<span>      covariateId <span class="op">=</span> <span class="fl">2052499839</span>,</span>
<span>      covariateValue <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">fitted.values</span> </span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">gisData</span> <span class="op">&lt;-</span> <span class="va">trainData</span><span class="op">$</span><span class="va">labels</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">gisData</span><span class="op">$</span><span class="va">PMVALUE</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">gisData</span><span class="op">$</span><span class="va">outcomeCount</span></span>
<span>    <span class="va">newData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span>    <span class="va">yHat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">newData</span><span class="op">)</span></span>
<span>    <span class="va">newData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      rowId <span class="op">=</span> <span class="va">gisData</span><span class="op">$</span><span class="va">rowId</span>,</span>
<span>      covariateId <span class="op">=</span> <span class="fl">2052499839</span>,</span>
<span>      covariateValue <span class="op">=</span> <span class="va">yHat</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># update covRef</span></span>
<span>  <span class="fu">Andromeda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Andromeda/man/appendToTable.html" class="external-link">appendToTable</a></span><span class="op">(</span><span class="va">trainData</span><span class="op">$</span><span class="va">covariateData</span><span class="op">$</span><span class="va">covariateRef</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>covariateId<span class="op">=</span><span class="fl">2052499839</span>,</span>
<span>                                      covariateName<span class="op">=</span><span class="st">'Average PM2.5 Concentrations'</span>,</span>
<span>                                      analysisId<span class="op">=</span><span class="fl">1</span>,</span>
<span>                                      conceptId<span class="op">=</span><span class="fl">2052499839</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># update covariates</span></span>
<span>  <span class="fu">Andromeda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Andromeda/man/appendToTable.html" class="external-link">appendToTable</a></span><span class="op">(</span><span class="va">trainData</span><span class="op">$</span><span class="va">covariateData</span><span class="op">$</span><span class="va">covariates</span>, <span class="va">newData</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">featureEngineering</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    funct <span class="op">=</span> <span class="st">'implementPollutants'</span>,</span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      featureEngineeringSettings <span class="op">=</span> <span class="va">featureEngineeringSettings</span>,</span>
<span>      model <span class="op">=</span> <span class="va">model</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">trainData</span><span class="op">$</span><span class="va">covariateData</span>, <span class="st">'metaData'</span><span class="op">)</span><span class="op">$</span><span class="va">featureEngineering</span> <span class="op">=</span> <span class="fu"><a href="../reference/listAppend.html">listAppend</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">trainData</span><span class="op">$</span><span class="va">covariateData</span>, <span class="st">'metaData'</span><span class="op">)</span><span class="op">$</span><span class="va">featureEngineering</span>,</span>
<span>    <span class="va">featureEngineering</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trainData</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trainData</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then execute these functions to create training and test data
objects that contain our extended covariates:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">featureEngineeringSettingsPol</span> <span class="op">&lt;-</span> <span class="fu">createPollutants</span><span class="op">(</span><span class="st">'QNCV'</span><span class="op">)</span></span>
<span><span class="va">trainDataPol</span> <span class="op">&lt;-</span> <span class="fu">implementPollutants</span><span class="op">(</span><span class="va">trainData</span>, <span class="va">featureEngineeringSettings</span><span class="op">)</span></span>
<span><span class="va">testDataPol</span> <span class="op">&lt;-</span> <span class="fu">implementPollutants</span><span class="op">(</span><span class="va">testData</span>, <span class="va">featureEngineeringSettings</span>, <span class="va">trainDataPol</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<p>Note that if we plot the output model of the <code>GAM</code> fitting
in the <code>implementPollutants</code> function, we end up with a plot
that aligns well with our underlying relationship between Odds Ratio and
PM2.5 concentration that we used to distribute our synthetic data by
location:</p>
<div class="float">
<img src="images/gis1.avif" alt="Covariate Fit"><div class="figcaption">Covariate Fit</div>
</div>
<div class="float">
<img src="images/gis2.avif" alt="OR Estimation"><div class="figcaption">OR Estimation</div>
</div>
</div>
<div class="section level4">
<h4 id="step-5-apply-new-train-and-test-datasets-to-runplp-and-evaluate-output">Step 5: Apply new train and test datasets to <code>runPlp</code> and
evaluate output<a class="anchor" aria-label="anchor" href="#step-5-apply-new-train-and-test-datasets-to-runplp-and-evaluate-output"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analysisId</span> <span class="op">&lt;-</span> <span class="st">'1'</span></span>
<span><span class="va">analysisPath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">saveDirectory</span>, <span class="va">analysisId</span><span class="op">)</span></span>
<span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  trainData <span class="op">=</span> <span class="va">trainDataPol</span>, </span>
<span>  modelSettings <span class="op">=</span> <span class="fu"><a href="../reference/setLassoLogisticRegression.html">setLassoLogisticRegression</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  analysisId <span class="op">=</span> <span class="va">analysisId</span>,</span>
<span>  analysisPath <span class="op">=</span> <span class="va">analysisPath</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ParallelLogger</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ParallelLogger/reference/logInfo.html" class="external-link">logInfo</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">'Training %s model'</span>,<span class="va">settings</span><span class="op">$</span><span class="va">modelSettings</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">fitPlp</span>, <span class="va">settings</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span> <span class="fu">ParallelLogger</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ParallelLogger/reference/logError.html" class="external-link">logError</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">prediction</span></span>
<span><span class="co"># remove prediction from model</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co">#apply to test data if exists:</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="st">'Test'</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">predictionTest</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/predictPlp.html">predictPlp</a></span><span class="op">(</span></span>
<span>      plpModel <span class="op">=</span> <span class="va">model</span>, </span>
<span>      plpData <span class="op">=</span> <span class="va">testDataPol</span>,</span>
<span>      population <span class="op">=</span> <span class="va">testDataPol</span><span class="op">$</span><span class="va">labels</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span> <span class="fu">ParallelLogger</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/ParallelLogger/reference/logError.html" class="external-link">logError</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictionTest</span><span class="op">$</span><span class="va">evaluationType</span> <span class="op">&lt;-</span> <span class="st">'Test'</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">predictionTest</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">predictionTest</span>, <span class="va">prediction</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span><span class="op">!=</span><span class="st">'index'</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Egill Fridgeirsson, Jenna Reps, Martijn Schuemie, Marc Suchard, Patrick Ryan, Peter Rijnbeek.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
