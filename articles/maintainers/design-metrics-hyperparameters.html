<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Design for custom hyperparameter search and tuning metrics • PatientLevelPrediction</title>
<script src="../../lightswitch.js"></script><script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Design for custom hyperparameter search and tuning metrics">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">PatientLevelPrediction</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">6.5.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../../articles/InstallationGuide.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../../articles/AddingCustomFeatureEngineering.html">Adding Custom Feature Engineering Functions</a></li>
    <li><a class="dropdown-item" href="../../articles/AddingCustomModels.html">Adding Custom Patient-Level Prediction Algorithms</a></li>
    <li><a class="dropdown-item" href="../../articles/AddingCustomSamples.html">Adding Custom Sampling Functions</a></li>
    <li><a class="dropdown-item" href="../../articles/AddingCustomSplitting.html">Adding Custom Data Splitting</a></li>
    <li><a class="dropdown-item" href="../../articles/BenchmarkTasks.html">Benchmark Tasks</a></li>
    <li><a class="dropdown-item" href="../../articles/BestPractices.html">Best Practice Research</a></li>
    <li><a class="dropdown-item" href="../../articles/BuildingMultiplePredictiveModels.html">Automatically Build Multiple Patient-Level Predictive Models</a></li>
    <li><a class="dropdown-item" href="../../articles/BuildingPredictiveModels.html">Building patient-level predictive models</a></li>
    <li><a class="dropdown-item" href="../../articles/ClinicalModels.html">Clinical Models</a></li>
    <li><a class="dropdown-item" href="../../articles/ConstrainedPredictors.html">Constrained Predictors</a></li>
    <li><a class="dropdown-item" href="../../articles/CreatingLearningCurves.html">Creating Learning Curves</a></li>
    <li><a class="dropdown-item" href="../../articles/CreatingNetworkStudies.html">Making patient-level predictive network study packages</a></li>
    <li><a class="dropdown-item" href="../../articles/GISExample.html">Integration of GIS Data Into OHDSI Model Building</a></li>
    <li><a class="dropdown-item" href="../../articles/InstallationGuide.html">Patient-Level Prediction Installation Guide</a></li>
    <li><a class="dropdown-item" href="../../articles/Videos.html">Demo Videos</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../articles/BenchmarkTasks.html">Benchmarks</a></li>
<li class="nav-item"><a class="nav-link" href="../../articles/ConstrainedPredictors.html">Predictors</a></li>
<li class="nav-item"><a class="nav-link" href="../../articles/BestPractices.html">Best Practices</a></li>
<li class="nav-item"><a class="nav-link" href="../../articles/ClinicalModels.html">Clinical Models</a></li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/PatientLevelPrediction"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Design for custom hyperparameter search and tuning metrics</h1>
                        <h4 data-toc-skip class="author">Egill
Fridgeirsson</h4>
            
            <h4 data-toc-skip class="date">2025-10-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/PatientLevelPrediction/blob/develop/vignettes/maintainers/design-metrics-hyperparameters.Rmd" class="external-link"><code>vignettes/maintainers/design-metrics-hyperparameters.Rmd</code></a></small>
      <div class="d-none name"><code>design-metrics-hyperparameters.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="new-helper-createhyperparametersettings">1. New helper: <code>createHyperparameterSettings()</code><a class="anchor" aria-label="anchor" href="#new-helper-createhyperparametersettings"></a>
</h2>
<p>Add a file <code>R/HyperparameterSettings.R</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">createHyperparameterSettings</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>      <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>      <span class="va">tuningMetric</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      <span class="va">sampleSize</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      <span class="va">randomSeed</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>      <span class="va">searchControl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="va">generator</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">search</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grid"</span>, <span class="st">"random"</span>, <span class="st">"custom"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">search</span>, <span class="st">"random"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sampleSize</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">sampleSize</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">generator</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.function.html" class="external-link">is.function</a></span><span class="op">(</span><span class="va">generator</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">search</span> <span class="op">&lt;-</span> <span class="st">"custom"</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        search <span class="op">=</span> <span class="va">search</span>,</span>
<span>        tuningMetric <span class="op">=</span> <span class="va">tuningMetric</span>,</span>
<span>        sampleSize <span class="op">=</span> <span class="va">sampleSize</span>,</span>
<span>        randomSeed <span class="op">=</span> <span class="va">randomSeed</span>,</span>
<span>        searchControl <span class="op">=</span> <span class="va">searchControl</span>,</span>
<span>        generator <span class="op">=</span> <span class="va">generator</span></span>
<span>      <span class="op">)</span>,</span>
<span>      class <span class="op">=</span> <span class="st">"hyperparameterSettings"</span></span>
<span>    <span class="op">)</span></span>
<span> <span class="op">}</span></span></code></pre></div>
<ul>
<li>search: <code>grid</code> (default, current behavior),
<code>random</code> (sample), or <code>custom</code> if you provide
generator.</li>
<li>
<code>tuningMetric</code>: object created with
<code>createTuningMetric()</code>; <code>NULL</code> falls back to
AUC/maximize.</li>
<li>
<code>sampleSize</code>: required when
<code>search = "random"</code>; number of parameter sets to draw.</li>
<li>
<code>randomSeed</code>: optional, ensures reproducible random
search.</li>
<li>
<code>searchControl</code>: free-form list for future knobs (e.g.,
stratified sampling).</li>
<li>
<code>generator</code>: optional function that receives the base
parameter grid and a copy of the settings and must return a list of
parameter sets; if present we force search = “custom”.</li>
</ul>
<p>Document this with <code>roxygen2</code> tags and run
<code><a href="https://roxygen2.r-lib.org/reference/roxygenize.html" class="external-link">roxygen2::roxygenize()</a></code> to document. ``</p>
<p>———</p>
</div>
<div class="section level2">
<h2 id="extend-createmodeldesign">2. Extend <code>createModelDesign()</code><a class="anchor" aria-label="anchor" href="#extend-createmodeldesign"></a>
</h2>
<p>In <code>R/RunMultiplePlp.R</code>:</p>
<ul>
<li>Update signature:</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">createModelDesign</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>      <span class="va">...</span>,</span>
<span>      <span class="va">hyperparameterSettings</span> <span class="op">=</span> <span class="fu">createHyperparameterSettings</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="va">runCovariateSummary</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">...</span></span>
<span>    <span class="va">settings</span><span class="op">$</span><span class="va">hyperparameterSettings</span> <span class="op">&lt;-</span> <span class="va">hyperparameterSettings</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">settings</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"modelDesign"</span></span>
<span>    <span class="va">settings</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<ul>
<li>Keep defaults so existing calls stay untouched.</li>
<li>Update docs describing <code>hyperparameterSettings</code>.</li>
</ul>
<p>———</p>
</div>
<div class="section level2">
<h2 id="propagate-through-runplp-pipeline">3. Propagate through <code>runPlp</code> pipeline<a class="anchor" aria-label="anchor" href="#propagate-through-runplp-pipeline"></a>
</h2>
<ul>
<li>
<code>R/RunPlp.R</code>: When building settings for the training
call, pass both <code>hyperparameterSettings</code> and their
<code>tuningMetric</code> into <code><a href="../../reference/fitPlp.html">fitPlp()</a></code>:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">hyperparameterSettings</span> <span class="op">&lt;-</span> <span class="va">modelDesign</span><span class="op">$</span><span class="va">hyperparameterSettings</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu">createHyperparameterSettings</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    trainData <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">Train</span>,</span>
<span>    modelSettings <span class="op">=</span> <span class="va">modelSettings</span>,</span>
<span>    hyperparameterSettings <span class="op">=</span> <span class="va">hyperparameterSettings</span>,</span>
<span>    analysisId <span class="op">=</span> <span class="va">analysisId</span>,</span>
<span>    analysisPath <span class="op">=</span> <span class="va">analysisPath</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note: <code>%||%</code> means take
<code>modelDesign$hyperparameterSettings</code> if it exists, otherwise
default to <code>createHyperparameterSettings()</code></p>
<ul>
<li>Update <code>runPlp</code> signature.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">runPlp</span>(</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    ...</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="at">modelSettings =</span> <span class="fu">setLassoLogisticRegression</span>(),</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="at">hyperparameterSettings =</span> <span class="fu">createHyperparameterSettings</span>(),</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    ...</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>Update docs to describe `hyperparameterSettings`</code></pre>
<ul>
<li>R/Fit.R: Update function signature:</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>  fitPlp <span class="ot">&lt;-</span> <span class="cf">function</span>(trainData,</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>                     modelSettings,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>                     <span class="at">hyperparameterSettings =</span> <span class="fu">createHyperparameterSettings</span>(),</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>                     <span class="at">search =</span> <span class="st">"grid"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>                     analysisId,</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>                     analysisPath) {</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    ...</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>      <span class="at">trainData =</span> trainData,</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>      <span class="at">modelSettings =</span> modelSettings,</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>      <span class="at">hyperparameterSettings =</span> hyperparameterSettings,</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>      <span class="at">analysisId =</span> analysisId,</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>      <span class="at">analysisPath =</span> analysisPath</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    )</span></code></pre></div>
<p>(Deprecate search if you like, but keep it for compatibility and let
it override <code>hyperparameterSettings$search</code> when
non-default.)</p>
<p>———</p>
</div>
<div class="section level2">
<h2 id="update-classifier-fitters">4. Update classifier fitters<a class="anchor" aria-label="anchor" href="#update-classifier-fitters"></a>
</h2>
<p>Each classifier with CV (e.g., <code>fitSklearn</code>,
<code>fitRclassifier</code>, <code>fitGradientBoostingMachine</code>,
<code>fitLightGBM)</code> gains a <code>hyperparameterSettings</code>
argument.</p>
<p>Within these functions:</p>
<ul>
<li>Call a new helper
<code>prepareHyperparameterGrid(param, hyperparameterSettings)</code>
(see next section) to obtain the actual list of parameter sets to
evaluate.</li>
<li>Pass both the <code>tuningMetric</code> and the final grid into the
CV routines.</li>
</ul>
<p>———</p>
</div>
<div class="section level2">
<h2 id="helpers-for-search-preparation">5. Helpers for search preparation<a class="anchor" aria-label="anchor" href="#helpers-for-search-preparation"></a>
</h2>
<ul>
<li>Replace the current “return a list of params” approach with a
lightweight iterator façade: <code>prepareHyperparameterGrid()</code>
now returns an object exposing <code>R next = function(history)</code> …
(and optionally finalize). The CV code simply calls candidate &lt;-
iterator$next(history) until it gets NULL, so grid, random, and custom
searches all execute through the same loop.</li>
<li>For grid and random, wrap the fully expanded combinations in that
iterator: keep a private index (or shuffled index for random), yield one
entry per call, and stop once the pool is exhausted. Seeding logic stays
unchanged but is now encapsulated in the iterator’s closure.</li>
<li>For custom searches accept both simple generators (functions
returning a finite list) and adaptive generators. Detect which shape was
supplied and wrap it so the iterator always exposes the next(history)
contract. Provide adapters so legacy one-shot functions still work while
more advanced strategies get a stateful interface.</li>
<li>Document an adaptive generator contract: initialize(definition,
settings) to set up any internal state, next(history) to emit the next
configuration using past performance, finalize(history) to clean up if
needed. The iterator constructor calls <code>initialize()</code> once,
then delegates each <code>next()</code> invocation, allowing techniques
like Bayesian optimization that fit surrogate models or maintain other
state between trials.</li>
<li>Retain backwards compatibility by allowing code that still expects a
plain list to receive one (wrap the iterator for now and emit a
deprecation warning), but direct all new fitters and CV routines to the
iterator-based API so every search strategy—static or adaptive—lives
behind the same helper and can hold state safely inside its
closure/environment.</li>
</ul>
<p>Example code: - <code>prepareHyperparameterGrid()</code> returns an
iterator object with next/finalize so every search path looks the
same:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>    prepareHyperparameterGrid <span class="ot">&lt;-</span> <span class="cf">function</span>(paramDefinition, hyperSettings, <span class="at">modelName =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>      settings <span class="ot">&lt;-</span> hyperSettings <span class="sc">%||%</span> <span class="fu">createHyperparameterSettings</span>()</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>      makeSequentialIterator <span class="ot">&lt;-</span> <span class="cf">function</span>(pool) {</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        i <span class="ot">&lt;-</span> <span class="dv">0</span><span class="dt">L</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>          <span class="at">next =</span> <span class="cf">function</span>(history) {</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>            i <span class="ot">&lt;&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span><span class="dt">L</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">&gt;</span> <span class="fu">length</span>(pool)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>            pool[[i]]</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>          },</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>          <span class="at">finalize =</span> <span class="cf">function</span>(history) <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>        )</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>      }</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(paramDefinition) {</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>          empty <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">list</span>())</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">makeSequentialIterator</span>(empty))</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>      }</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>      expanded <span class="ot">&lt;-</span> <span class="fu">expandParamDefinition</span>(paramDefinition)</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">identical</span>(settings<span class="sc">$</span>search, <span class="st">"grid"</span>)) {</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">makeSequentialIterator</span>(expanded))</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>      }</span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">identical</span>(settings<span class="sc">$</span>search, <span class="st">"random"</span>)) {</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>        idx <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>          <span class="fu">length</span>(expanded),</span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>          <span class="at">size =</span> <span class="fu">min</span>(settings<span class="sc">$</span>sampleSize, <span class="fu">length</span>(expanded))</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>        )</span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">makeSequentialIterator</span>(expanded[idx]))</span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>      }</span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">identical</span>(settings<span class="sc">$</span>search, <span class="st">"custom"</span>)) {</span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>        generator <span class="ot">&lt;-</span> settings<span class="sc">$</span>generator</span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.function</span>(generator)) {</span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>          pool <span class="ot">&lt;-</span> <span class="fu">generator</span>(</span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>            <span class="at">definition =</span> paramDefinition, </span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>            <span class="at">expanded =</span> expanded, </span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>            <span class="at">settings =</span> settings</span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>          )</span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">makeSequentialIterator</span>(pool))</span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>        }</span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>        generator<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a>          <span class="at">definition =</span> paramDefinition,</span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>          <span class="at">settings =</span> settings</span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>        )</span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>          <span class="at">next =</span> <span class="cf">function</span>(history) generator<span class="sc">$</span><span class="cf">next</span>(history),</span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a>          <span class="at">finalize =</span> <span class="cf">function</span>(history) {</span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a>              finalizeFn <span class="ot">&lt;-</span> generator<span class="sc">$</span>finalize <span class="sc">%||%</span> <span class="cf">function</span>(...) <span class="fu">invisible</span>(<span class="cn">NULL</span>)</span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a>              <span class="fu">finalizeFn</span>(history)</span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a>        <span class="er">))</span></span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a>      }</span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">sprintf</span>(<span class="st">"Unknown hyper-parameter search strategy '%s'."</span>, settings<span class="sc">$</span>search))</span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a>    <span class="er">}</span></span></code></pre></div>
<ul>
<li>The unified CV loop consumes the iterator uniformly:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    iterator <span class="ot">&lt;-</span> <span class="fu">prepareHyperparameterGrid</span>(</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>      paramDefinition, </span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>      hyperSettings, </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>      modelName</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>      )</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    history <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>      candidate <span class="ot">&lt;-</span> iterator<span class="sc">$</span><span class="cf">next</span>(history)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(candidate)) <span class="cf">break</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>      perf <span class="ot">&lt;-</span> <span class="fu">evaluateCandidate</span>(candidate, data, metric)</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>      history[[<span class="fu">length</span>(history) <span class="sc">+</span> <span class="dv">1</span><span class="dt">L</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">param =</span> candidate, <span class="at">performance =</span> perf)</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    }</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>    iterator<span class="sc">$</span><span class="fu">finalize</span>(history)</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>    best <span class="ot">&lt;-</span> <span class="fu">selectBest</span>(history, metric)</span></code></pre></div>
<p>Grid, random, and adaptive custom searches all plug into this
structure by returning an iterator that maintains its own state inside
the closure or generator object.</p>
<p>———</p>
</div>
<div class="section level2">
<h2 id="modify-cv-routines">6. Modify CV routines<a class="anchor" aria-label="anchor" href="#modify-cv-routines"></a>
</h2>
<ul>
<li>
<code>gridCvPython(..., hyperparameterSettings, metric)</code> (or
similar) now receives the metric and uses it:</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>evaluated <span class="ot">&lt;-</span> <span class="fu">lapply</span>(grid, <span class="cf">function</span>(entry) {</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="fu">computeGridPerformance</span>(</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="at">prediction =</span> entry<span class="sc">$</span>prediction,</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="at">param =</span> entry<span class="sc">$</span>param,</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    <span class="at">metric =</span> metric</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  )</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>})</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>whichBest <span class="ot">&lt;-</span> <span class="cf">if</span> (metric<span class="sc">$</span>maximize) {</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  <span class="fu">which.max</span>(<span class="fu">vapply</span>(evaluated, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">numeric</span>(<span class="dv">1</span>), <span class="st">"cvPerformance"</span>))</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="fu">which.min</span>(<span class="fu">vapply</span>(evaluated, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">numeric</span>(<span class="dv">1</span>), <span class="st">"cvPerformance"</span>))</span></code></pre></div>
<ul>
<li>
<code><a href="../../reference/computeGridPerformance.html">computeGridPerformance()</a></code> signature changes:</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">computeGridPerformance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction</span>, <span class="va">param</span>, <span class="va">metric</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">perf</span> <span class="op">&lt;-</span> <span class="va">metric</span><span class="op">$</span><span class="fu">fun</span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span></span>
<span>    <span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">index</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">foldId</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">metric</span><span class="op">$</span><span class="fu">fun</span><span class="op">(</span><span class="va">prediction</span><span class="op">[</span><span class="va">prediction</span><span class="op">$</span><span class="va">index</span> <span class="op">==</span> <span class="va">foldId</span>, <span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">...</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      metric <span class="op">=</span> <span class="va">metric</span><span class="op">$</span><span class="va">label</span>,</span>
<span>      cvPerformance <span class="op">=</span> <span class="va">perf</span>,</span>
<span>      cvPerformancePerFold <span class="op">=</span> <span class="va">folds</span>,</span>
<span>      param <span class="op">=</span> <span class="va">param</span>,</span>
<span>      hyperSummary <span class="op">=</span> <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>For metrics needing thresholds, the supplied function can capture the
threshold:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu">createTuningMetric</span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">value</span> <span class="op">&gt;=</span> <span class="fl">0.6</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pred</span> <span class="op">==</span> <span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">outcomeCount</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    maximize <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Accuracy@0.6"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Because the function itself closes over 0.6, no extra plumbing is
needed.</p>
<p>———</p>
</div>
<div class="section level2">
<h2 id="backward-compatibility">7. Backward compatibility<a class="anchor" aria-label="anchor" href="#backward-compatibility"></a>
</h2>
<ul>
<li>
<code>modelSettings$param</code> can remain unchanged, so any
package that provides a custom parameter grid continues to work.</li>
<li>If someone relies on attributes like attr(param, “settings”)$search,
we keep them for now but warn in documentation that
<code>createHyperparameterSettings()</code> is the new home for search
configuration.</li>
<li>Keep the positional search argument on <code><a href="../../reference/fitPlp.html">fitPlp()</a></code> (and
maybe on the classifier fitters) but internally let it override the
design-level setting only when explicitly set, e.g.:</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">search</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">hyperparameterSettings</span><span class="op">$</span><span class="va">search</span> <span class="op">&lt;-</span> <span class="va">search</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>This means existing code that calls
<code>fitPlp(..., search = "grid")</code> keeps working.</p>
<p>———</p>
</div>
<div class="section level2">
<h2 id="usage-example">8. Usage example<a class="anchor" aria-label="anchor" href="#usage-example"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">metric</span> <span class="op">&lt;-</span> <span class="fu">createTuningMetric</span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">value</span> <span class="op">&gt;=</span> <span class="fl">0.55</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">outcomeCount</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    maximize <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Accuracy@0.55"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">hyperSettings</span> <span class="op">&lt;-</span> <span class="fu">createHyperparameterSettings</span><span class="op">(</span></span>
<span>    search <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>    tuningMetric <span class="op">=</span> <span class="va">metric</span>,</span>
<span>    sampleSize <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    randomSeed <span class="op">=</span> <span class="fl">42</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">modelDesign</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/createModelDesign.html">createModelDesign</a></span><span class="op">(</span></span>
<span>    targetId <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    outcomeId <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    modelSettings <span class="op">=</span> <span class="fu"><a href="../../reference/setAdaBoost.html">setAdaBoost</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    hyperparameterSettings <span class="op">=</span> <span class="va">hyperSettings</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/runMultiplePlp.html">runMultiplePlp</a></span><span class="op">(</span>databaseDetails <span class="op">=</span> <span class="va">databaseDetails</span>, modelDesignList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">modelDesign</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>———</p>
</div>
<div class="section level2">
<h2 id="tests-docs">9. Tests &amp; docs<a class="anchor" aria-label="anchor" href="#tests-docs"></a>
</h2>
<ul>
<li>New tests for <code>prepareHyperparameterGrid()</code> random
sampling behavior and custom generator.</li>
<li>Tests verifying the metric and search settings affect the CV
selection.</li>
<li>Tests</li>
<li>Doc updates: <code>createModelDesign</code>, <code>runPlp</code>,
<code>fitPlp</code>, <code>set*</code> helpers referencing the new
design-level configuration.</li>
<li>Test reverse depencies like <code>DeepPatientLevelPrediction</code>,
if it doesn’t work with the new design, it’s a breaking change and needs
to be fixed</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Egill Fridgeirsson, Jenna Reps, Martijn Schuemie, Marc Suchard, Patrick Ryan, Peter Rijnbeek.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
